name: Deploy to Linode

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LINODE_SSH_PRIVATE_KEY }}

      - name: Deploy app to Linode
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }} << 'EOF'
            cd ~
            if [ ! -d "sgfb" ]; then
              git clone https://github.com/emmauopeople/Sgfb.git sgfb
            fi
            cd sgfb
            git pull origin main
            npm install

            # Start or restart both apps
            pm2 restart sgfb-admin || pm2 start app.js --name sgfb-admin
            pm2 restart sgfb-customer || pm2 start customer_app.js --name sgfb-customer

            # Set up NGINX
            sudo tee /etc/nginx/sites-available/sgfb << 'NGINX_CONF'
            server {
              listen 80;
              server_name admin.smellsgoodfeelbeter.com;

              location / {
                proxy_pass http://localhost:3000;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection 'upgrade';
              }
            }

            server {
              listen 80;
              server_name www.smellsgoodfeelbeter.com;

              location / {
                proxy_pass http://localhost:3001;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection 'upgrade';
              }
            }
            NGINX_CONF

            sudo ln -sf /etc/nginx/sites-available/sgfb /etc/nginx/sites-enabled/sgfb
            sudo nginx -t && sudo systemctl reload nginx
          EOF
