name: Deploy to Linode

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LINODE_SSH_PRIVATE_KEY }}

      - name: Deploy to Linode
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }} << 'EOF'
            cd ~/sgfb || exit 1

            echo "ðŸ”„ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "ðŸ“¦ Installing dependencies..."
            npm install

            echo "ðŸš€ Restarting apps with PM2..."
            pm2 restart sgfb-admin || pm2 start app.js --name sgfb-admin
            pm2 restart sgfb-customer || pm2 start customer_app.js --name sgfb-customer

            echo "âš™ï¸  Setting up NGINX config..."
            sudo tee /etc/nginx/sites-available/sgfb << 'NGINX_CONF'
            server {
              listen 80;
              server_name admin.smellsgoodfeelbeter.com;

              location / {
                proxy_pass http://localhost:3000;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host \$host;
                proxy_cache_bypass \$http_upgrade;
              }
            }

            server {
              listen 80;
              server_name www.smellsgoodfeelbeter.com;

              location / {
                proxy_pass http://localhost:3001;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host \$host;
                proxy_cache_bypass \$http_upgrade;
              }
            }
            NGINX_CONF

            echo "ðŸ” Reloading NGINX..."
            sudo ln -sf /etc/nginx/sites-available/sgfb /etc/nginx/sites-enabled/sgfb
            sudo nginx -t && sudo systemctl reload nginx
          EOF
